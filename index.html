<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wizard Typing: Scarlett's Academy</title>
    <style>
        :root { --wizard-gold: #f1d38e; --wizard-red: #741b1b; --wizard-blue: #4facfe; --bg-dark: #0d0d1a; }
        body { margin: 0; overflow: hidden; background: var(--bg-dark); font-family: 'Georgia', serif; color: var(--wizard-gold); display: flex; flex-direction: column; height: 100vh; }
        
        #game-container { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: row; }
        
        #sidebar { 
            width: 240px; background: rgba(20, 20, 40, 0.8); border-right: 3px solid var(--wizard-red); 
            padding: 15px; box-sizing: border-box; display: flex; flex-direction: column; z-index: 30; gap: 12px;
        }
        .parchment-box {
            background: #f4e4bc; color: #2a0a0a; padding: 10px; border-radius: 5px; border: 2px solid #d4c49c;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2); font-size: 0.82rem; line-height: 1.3;
        }
        .parchment-box h3 { margin-top: 0; color: var(--wizard-red); font-size: 0.9rem; border-bottom: 1px solid rgba(116, 27, 27, 0.3); margin-bottom: 5px; }
        .tips-box { background: #e8d5a7; border-color: #c4b48c; }

        /* Medallion Display */
        #artifact-container { position: relative; width: 100px; height: 100px; margin: 10px auto; display: flex; align-items: center; justify-content: center; }
        .artifact-fragment {
            position: absolute; width: 35px; height: 35px; background: #3d3d5c; border: 1px solid rgba(241, 211, 142, 0.3);
            border-radius: 5px; opacity: 0.1; transition: all 1s ease;
        }
        .artifact-fragment.collected {
            background: radial-gradient(circle, #ffd700, #b8860b); opacity: 1; box-shadow: 0 0 15px #ffd700; border-color: #fff;
        }
        #artifact-container.complete { animation: pulse-gold 2s infinite alternate; }
        @keyframes pulse-gold { from { filter: drop-shadow(0 0 5px #ffd700); transform: scale(1); } to { filter: drop-shadow(0 0 25px #ffd700); transform: scale(1.1); } }

        #main-play-area { flex: 1; display: flex; flex-direction: column; position: relative; }
        #ui-layer { width: 100%; padding: 15px; display: flex; justify-content: space-between; box-sizing: border-box; z-index: 20; background: var(--bg-dark); border-bottom: 3px solid var(--wizard-red); }
        canvas { flex: 1; display: block; width: 100%; background: #0d0d1a; }

        #snitch-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px; margin-top: 5px; }
        .snitch { width: 18px; height: 18px; fill: rgba(255,255,255,0.1); transition: all 0.4s ease; filter: grayscale(1); }
        .snitch.active { fill: #ffd700; filter: drop-shadow(0 0 5px #ffd700) grayscale(0); transform: scale(1.2); }
        #lives-display { color: #ff4d4d; font-size: 20px; letter-spacing: 2px; margin-top: 5px; }

        #speed-controls { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 8px; z-index: 100; align-items: center; }
        .speed-btn { padding: 10px; font-size: 20px; background: rgba(116, 27, 27, 0.6); color: var(--wizard-gold); border: 2px solid var(--wizard-gold); border-radius: 8px; cursor: pointer; width: 50px; }
        #speed-val-display { font-weight: bold; font-size: 14px; text-shadow: 0 0 5px black; }

        #keyboard-section { height: 200px; background: #1a1a2e; border-top: 4px solid var(--wizard-red); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; position: relative; }
        .key-row { display: flex; align-items: center; margin-bottom: 4px; }
        .row-label { width: 110px; text-align: right; margin-right: 15px; font-size: 0.7rem; text-transform: uppercase; color: var(--wizard-blue); letter-spacing: 1px; font-weight: bold; opacity: 0.8; transition: all 0.2s; }
        .row-label.spark { color: var(--wizard-gold); text-shadow: 0 0 10px var(--wizard-gold); transform: scale(1.1); opacity: 1; }

        .key { width: 7vw; max-width: 40px; height: 40px; border: 1px solid #3d3d5c; border-radius: 6px; margin: 2px; display: flex; align-items: center; justify-content: center; font-size: 16px; font-family: 'Courier New', monospace; color: #5c5c8a; background: #121225; transition: 0.1s; }
        .key.active { background: var(--wizard-gold); color: #2a0a0a; box-shadow: 0 0 15px var(--wizard-gold); transform: scale(0.9); }
        .key.guide { border-color: var(--wizard-blue); box-shadow: 0 0 15px var(--wizard-blue); color: #fff; background: #1e3a5f; }
        .key.locked { opacity: 0.15; }
        #k-F, #k-J { border-bottom: 3px solid var(--wizard-blue); }

        #input-display { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); font-size: 30px; color: #2a0a0a; background: var(--wizard-gold); padding: 5px 35px; border-radius: 10px; border: 3px solid var(--wizard-red); font-weight: bold; z-index: 5; height: 40px; min-width: 120px; text-align: center; line-height: 40px;}

        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 100; background: rgba(13, 13, 26, 0.98); }
        .scroll { background: #f4e4bc; color: #2a0a0a; padding: 25px; border-radius: 8px; text-align: center; width: 90%; max-width: 500px; border: 3px solid #d4c49c; box-shadow: 0 0 30px #000; overflow-y: auto; max-height: 90vh; }
        .syllabus-table { width: 100%; font-size: 0.75rem; text-align: left; margin: 10px 0; border-collapse: collapse; }
        .syllabus-table td { padding: 6px; border-bottom: 1px solid rgba(0,0,0,0.1); }

        button { padding: 12px; font-size: 1.1rem; background: var(--wizard-red); color: var(--wizard-gold); border: 2px solid var(--wizard-gold); cursor: pointer; border-radius: 8px; font-weight: bold; margin-top: 10px; width: 100%; }
        #watermark { padding-top: 10px; font-size: 13px; text-align: center; color: var(--wizard-gold); font-style: italic; opacity: 0.9; text-shadow: 0 0 5px rgba(241, 211, 142, 0.4); }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="sidebar">
            <div class="parchment-box">
                <h3 id="sidebar-title">Year 1</h3>
                <p id="sidebar-task"></p>
            </div>
            
            <div class="parchment-box" style="text-align: center;">
                <h3>Mastery Medallion</h3>
                <div id="artifact-container">
                    <div class="artifact-fragment" style="transform: rotate(0deg) translate(30px);" id="frag-1"></div>
                    <div class="artifact-fragment" style="transform: rotate(60deg) translate(30px);" id="frag-2"></div>
                    <div class="artifact-fragment" style="transform: rotate(120deg) translate(30px);" id="frag-3"></div>
                    <div class="artifact-fragment" style="transform: rotate(180deg) translate(30px);" id="frag-4"></div>
                    <div class="artifact-fragment" style="transform: rotate(240deg) translate(30px);" id="frag-5"></div>
                    <div class="artifact-fragment" style="transform: rotate(300deg) translate(30px);" id="frag-6"></div>
                </div>
                <p id="artifact-status" style="font-size: 0.65rem; color: #666; margin: 0;">Frag 0/6 Collected</p>
            </div>

            <div class="parchment-box tips-box">
                <h3>Wizard's Tips</h3>
                <p id="sidebar-tips" style="font-size: 0.75rem; font-style: italic;"></p>
            </div>
            <div style="flex:1"></div>
            <div id="watermark">Made for Scarlett, by Daddy</div>
        </div>

        <div id="main-play-area">
            <div id="ui-layer">
                <div>YEAR: <span id="lvl-val">1</span><div id="lives-display"></div></div>
                <div id="progress-center">
                    <div id="snitch-grid"></div>
                </div>
                <div>POINTS: <span id="score-val">0</span></div>
            </div>

            <div id="speed-controls">
                <button class="speed-btn" onclick="changeSpeed(0.2)">‚ñ≤</button>
                <div id="speed-val-display">SPEED: 1.0x</div>
                <button class="speed-btn" onclick="changeSpeed(-0.2)">‚ñº</button>
            </div>

            <canvas id="gameCanvas"></canvas>
            <div id="input-display">READY</div>
        </div>
    </div>

    <div id="start-screen" class="overlay">
        <div class="scroll">
            <h1 style="color: var(--wizard-red); margin: 0;">Academy Syllabus</h1>
            <p style="font-size: 0.9rem; margin: 5px;">Academy Highscore: <span id="lobby-highscore" style="font-weight: bold; color: var(--wizard-red);">0</span></p>
            <table class="syllabus-table">
                <tr><td><b>Year 1</b></td><td>Home Row + E, I, R, U (Single Letters)</td></tr>
                <tr><td><b>Year 2</b></td><td>Full Top Row (Single Letters)</td></tr>
                <tr><td><b>Year 3</b></td><td>Full Bottom Row (Single Letters)</td></tr>
                <tr><td><b>Year 4</b></td><td>Short Spells (2-3 letters)</td></tr>
                <tr><td><b>Year 5</b></td><td>Medium Spells (4-6 letters)</td></tr>
                <tr><td><b>Year 6</b></td><td>Advanced Magic (Full Words)</td></tr>
            </table>
            <input type="text" id="name-input" placeholder="Enter Name" maxlength="12" style="width:80%; padding:10px; margin:10px; border:2px solid var(--wizard-red); border-radius:5px; text-align:center;">
            <div style="margin: 10px 0; font-size: 0.9rem;">
                <label><input type="radio" name="lives-mode" value="999" checked> ‚ôæÔ∏è Practice</label>
                <label><input type="radio" name="lives-mode" value="5"> ‚ù§Ô∏è 5 Lives</label>
            </div>
            <button onclick="startGame()">BEGIN LESSON (Enter)</button>
        </div>
    </div>

    <div id="pause-screen" class="overlay" style="display: none;">
        <div class="scroll" style="background: #1a1a2e; border: 3px solid var(--wizard-blue); color: white;">
            <h1>Magic Suspended</h1>
            <button onclick="togglePause()">RESUME MAGIC (Esc)</button>
        </div>
    </div>

    <div id="report-card" class="overlay" style="display: none;">
        <div class="scroll">
            <h1 id="rep-title">üìú Year Passed!</h1>
            <div id="artifact-reward-box" style="margin: 15px auto; padding: 10px; border: 2px dashed var(--wizard-red); border-radius: 10px; display:none;">
                <p style="font-weight: bold; color: var(--wizard-red); margin: 5px 0;">‚ú® Fragment Collected! ‚ú®</p>
            </div>
            <p id="rep-stats"></p>
            <p id="highscore-msg" style="font-weight: bold; color: #2e7d32; display: none;">üèÜ NEW HIGHSCORE! üèÜ</p>
            <button id="advance-btn" onclick="nextYear()">ADVANCE (Enter)</button>
            <button onclick="location.reload()" style="background:#3d3d5c; margin-top:5px;">BACK TO LOBBY</button>
        </div>
    </div>

    <div id="keyboard-section">
        <div class="key-row" id="r1"><div class="row-label" id="label-r1">Top Row ‚ûî</div></div>
        <div class="key-row" id="r2"><div class="row-label" id="label-r2">Home Row ‚ûî</div></div>
        <div class="key-row" id="r3"><div class="row-label" id="label-r3">Bottom Row ‚ûî</div></div>
    </div>

    <template id="snitch-svg">
        <svg class="snitch" viewBox="0 0 24 24"><path d="M12,2L10,5L12,8L14,5L12,2M12,10C8.69,10 6,12.69 6,16C6,19.31 8.69,22 12,22C15.31,22 18,19.31 18,16C18,12.69 15.31,10 12,10M12,20C9.79,20 8,18.21 8,16C8,13.79 9.79,12 12,12C14.21,12 16,13.79 16,16C16,18.21 14.21,20 12,20M2,16C2,14 4,12 4,12C4,12 4,16 2,16M22,16C22,14 20,12 20,12C20,12 20,16 22,16Z"/></svg>
    </template>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type, duration, vol) {
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }

        const sounds = {
            correct: () => playTone(880, 'sine', 0.2, 0.1),
            wrong: () => { playTone(120, 'sawtooth', 0.1, 0.1); setTimeout(() => playTone(100, 'sawtooth', 0.15, 0.1), 50); },
            levelUp: () => { playTone(523.25,'sine',0.2,0.1); setTimeout(()=>playTone(659.25,'sine',0.2,0.1),100); setTimeout(()=>playTone(783.99,'sine',0.4,0.1),200); },
            complete: () => { [523, 659, 783, 1046].forEach((f,i) => setTimeout(()=>playTone(f, 'sine', 0.5, 0.1), i*150)); }
        };

        const YEAR_DATA = {
            1: { keys: "ASDFGHJKLEIRU", words: false, title: "Year 1: Home Base", task: "Home Row + E, I, R, U.", tips: "Keep index fingers on F & J. Move one finger at a time." },
            2: { keys: "ASDFGHJKLEIRUQWTYOP", words: false, title: "Year 2: High Altitudes", task: "Full Top Row added.", tips: "Reach up to the Top Row, then hop it right back home." },
            3: { keys: "ABCDEFGHIJKLMNOPQRSTUVWXYZ", words: false, title: "Year 3: Deep Dungeons", task: "Full keyboard unlocked.", tips: "Bottom row is tricky! Keep your wrists light like a piano player." },
            4: { keys: "ABCDEFGHIJKLMNOPQRSTUVWXYZ", words: true, min: 2, max: 3, title: "Year 4: Basic Charms", task: "Short spells (2-3 letters).", tips: "Type in a steady rhythm! One-two, one-two." },
            5: { keys: "ABCDEFGHIJKLMNOPQRSTUVWXYZ", words: true, min: 4, max: 6, title: "Year 5: Master Spells", task: "Medium spells (4-6 letters).", tips: "Don't look at your hands! Trust your fingers to remember." },
            6: { keys: "ABCDEFGHIJKLMNOPQRSTUVWXYZ", words: true, min: 7, max: 20, title: "Year 6: Ultimate Magic", task: "The final test!", tips: "Master Wizard level! Complete the words to finish the medallion." }
        };

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const seeds = ["WAND", "ROBE", "OWL", "HAT", "INK", "FLY", "CAT", "RAT", "CUP", "BOY", "MAP", "KEY", "BED", "TEA", "SUN", "BAG", "BOOK", "TOAD", "GOLD", "GATE", "FIRE", "WALL", "CAKE", "WIND", "BIRD", "SNOW", "SHIP", "MILK", "JUMP", "DARK", "FAST", "LOCK", "DOOR", "WOOD", "TREE", "SOUP", "COIN", "DUST", "DESK", "FROG", "MAGIC", "CLOAK", "TRAIN", "GHOST", "SPELL", "BRICK", "STONE", "BROOM", "STAIR", "PIZZA", "STARS", "NIGHT", "LIGHT", "GLOVE", "SNAKE", "MOUSE", "VAULT", "SCARF", "POTION", "WIZARD", "CASTLE", "DRAGON", "GOBLIN", "MIRROR", "SCHOOL", "FLOWER", "GIANTS", "DIARY", "SPIDER", "FOREST", "KNIGHT", "SILVER", "PURPLE", "SHIELD", "SPIRIT", "ARMOR", "GARDEN", "KITCHEN", "PUMPKIN", "BROOMS", "CAULDRON", "FEATHER", "LIBRARY", "WHISPER", "PHANTOM", "ALCHEMY", "CRYSTAL", "LANTERN", "SHADOW", "TOWER", "BRIDGE", "SCROLL", "BEAST", "TICKET", "CANDLE", "REMEDY", "BREW", "ELIXIR", "TALENT", "QUEST", "AMULET", "CHARM", "JINX", "HEX", "RUNE", "SIGHT", "DREAM", "FLAME", "FROST", "STORM", "CLOUD", "POWER", "CROWN", "SCEPTRE", "VALLEY", "MOUNTAIN", "ISLAND", "OCEAN", "DESERT", "JUNGLE", "CAVERN", "TUNNEL", "TEMPLE", "STATUE", "PILLAR", "THRONE", "CHAMBER", "PASSAGE", "SECRET", "RIDDLE", "PUZZLE", "SYMBOL", "LEGEND", "FABLE", "STORY", "MYTH", "REWARD", "TROPHY", "MEDAL", "BADGE", "TOKEN", "JEWEL", "DIAMOND", "RUBY", "PEARL", "EMERALD", "SAPPHIRE", "BOTTLE", "CHEST", "BASKET", "HAMMER", "CHISEL", "NEEDLE", "THREAD", "FABRIC", "LEATHER", "CANVAS", "GRIFFIN", "PHOENIX", "UNICORN", "CENTAUR", "MERMAID", "PIXIE", "FAIRY", "GNOME", "TROLL", "GOLEM", "KEEPER", "MASTER", "ELDER", "LEADER", "FRIEND", "COUSIN", "FAMILY", "SISTER", "BROTHER", "FATHER", "MOTHER", "WITCH", "BROOMSTICK", "HALLOWEEN", "CANDY", "CAULDRONS", "HERBOLOGY", "DIVINATION", "TRANSFIGURATION", "ASTRONOMY", "QUIDDITCH", "SNITCH", "BLUDGER", "QUAFFLE", "BEATER", "CHASER", "SEEKER", "CAPTAIN", "VICTORY", "GRIFFINDOR", "SLYTHERIN", "HUFFLEPUFF", "RAVENCLAW", "DORMITORY", "PORTRAIT", "PASSWORD", "DUNGEON", "GHOSTLY", "HAUNTED", "EERIE", "MYSTIC", "ORB", "TALISMAN", "ENCHANTED", "BEWITCHED", "GLIMMER", "SPARKLE", "SHIMMER", "ETERNAL"].map(w => w.toUpperCase());

        const keyMap = {}; const layouts = [{id:'r1',chars:"QWERTYUIOP"},{id:'r2',chars:"ASDFGHJKL"},{id:'r3',chars:"ZXCVBNM"}];
        layouts.forEach(r => {
            const el = document.getElementById(r.id);
            r.chars.split("").forEach(c => {
                keyMap[c] = r.id; const k = document.createElement('div');
                k.className = 'key'; k.id = 'k-' + c; k.innerText = c; el.appendChild(k);
            });
        });

        const snitchGrid = document.getElementById('snitch-grid'); const snitchTemplate = document.getElementById('snitch-svg');
        for(let i=0; i<20; i++) snitchGrid.appendChild(snitchTemplate.content.cloneNode(true));

        let activeWords = [], score = 0, level = 1, typed = 0, lives = 5, active = false, reporting = false, paused = false, inputStr = "", lastS = 0, targetedWord = null, fallSpeedMult = 1.0;

        // HIGHSCORE LOGIC
        function getHighscore() { return localStorage.getItem('wizardHighscore') || 0; }
        function saveHighscore(s) { if (s > getHighscore()) { localStorage.setItem('wizardHighscore', s); return true; } return false; }
        document.getElementById('lobby-highscore').innerText = getHighscore();

        function changeSpeed(d) { fallSpeedMult = Math.max(0.4, Math.min(3.0, fallSpeedMult + d)); document.getElementById('speed-val-display').innerText = `SPEED: ${fallSpeedMult.toFixed(1)}x`; }
        function togglePause() { if (!active || reporting) return; paused = !paused; document.getElementById('pause-screen').style.display = paused ? 'flex' : 'none'; if (!paused) { lastS = performance.now(); requestAnimationFrame(loop); } }
        function startGame() { if (audioCtx.state === 'suspended') audioCtx.resume(); lives = parseInt(document.querySelector('input[name="lives-mode"]:checked').value); score = 0; level = 1; document.getElementById('start-screen').style.display = 'none'; resetGameSession(); requestAnimationFrame(loop); }
        function resetGameSession() { typed = 0; activeWords = []; inputStr = ""; active = true; reporting = false; targetedWord = null; paused = false; updateSidebar(); resetSnitches(); resize(); updateUI(); }
        
        function updateSidebar() { 
            const d = YEAR_DATA[level] || YEAR_DATA[6]; 
            document.getElementById('sidebar-title').innerText = d.title; 
            document.getElementById('sidebar-task').innerText = d.task; 
            document.getElementById('sidebar-tips').innerText = d.tips; 
            document.getElementById('artifact-status').innerText = `Frag ${level-1}/6 Collected`;
        }

        function resetSnitches() { document.querySelectorAll('.snitch').forEach(s => s.classList.remove('active')); }
        function resize() { canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight; }
        window.onresize = resize;

        function updateUI() {
            document.getElementById('score-val').innerText = score;
            document.getElementById('lvl-val').innerText = level;
            document.getElementById('lives-display').innerText = lives > 10 ? "‚ôæÔ∏è" : "‚ù§Ô∏è".repeat(lives);
            document.querySelectorAll('.snitch').forEach((s, i) => i < typed ? s.classList.add('active') : s.classList.remove('active'));
            const allowed = YEAR_DATA[level]?.keys || "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            document.querySelectorAll('.key').forEach(k => {
                const char = k.id.split('-')[1];
                k.classList.remove('guide');
                if (!allowed.includes(char)) k.classList.add('locked'); else k.classList.remove('locked');
            });
            if (targetedWord) { 
                let char = targetedWord.text[inputStr.length]; 
                if (char) document.getElementById('k-' + char)?.classList.add('guide'); 
            }
        }

        class Word {
            constructor() {
                const config = YEAR_DATA[level] || YEAR_DATA[6];
                if (!config.words) {
                    this.text = config.keys[Math.floor(Math.random() * config.keys.length)];
                } else {
                    const filtered = seeds.filter(w => w.length >= config.min && w.length <= config.max);
                    const pool = filtered.length > 0 ? filtered : ["MAGIC"];
                    this.text = pool[Math.floor(Math.random() * pool.length)];
                }
                this.x = Math.random() * (canvas.width - 150) + 75; this.y = -30;
                this.speed = (0.3 + (level * 0.12)) * fallSpeedMult;
            }
            draw() {
                ctx.textAlign = "center"; ctx.font = "bold 28px 'Courier New'";
                if (targetedWord === this) {
                    const fullW = ctx.measureText(this.text).width;
                    const typedW = ctx.measureText(this.text.substring(0, inputStr.length)).width;
                    const startX = this.x - (fullW/2);
                    ctx.fillStyle = "#ffffff"; ctx.fillText(this.text.substring(0, inputStr.length), startX + (typedW/2), this.y);
                    ctx.fillStyle = "#ffd700"; ctx.fillText(this.text.substring(inputStr.length), startX + typedW + (ctx.measureText(this.text.substring(inputStr.length)).width/2), this.y);
                } else { ctx.fillStyle = "#f1d38e"; ctx.fillText(this.text, this.x, this.y); }
            }
        }

        function loop(t) {
            if (!active || reporting || paused) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (t - lastS > (5000 - (level * 450)) / Math.sqrt(fallSpeedMult)) { activeWords.push(new Word()); lastS = t; }
            activeWords.forEach((w, i) => {
                w.y += w.speed; w.draw();
                if (w.y > canvas.height) { 
                    if (targetedWord === w) { targetedWord = null; inputStr = ""; } 
                    activeWords.splice(i, 1); 
                    if (lives <= 10) { lives--; if (lives <= 0) endGame(); } 
                    updateUI(); 
                }
            });
            requestAnimationFrame(loop);
        }

        function handleKey(char) {
            if (!active || reporting || paused) return;
            const c = char.toUpperCase();
            if (!(YEAR_DATA[level]?.keys || "").includes(c)) { sounds.wrong(); return; }
            const kEl = document.getElementById('k-' + c);
            if (kEl) { kEl.classList.add('active'); setTimeout(() => kEl.classList.remove('active'), 100); }
            
            let hit = false;
            if (!targetedWord) {
                const matches = activeWords.filter(w => w.text.startsWith(c));
                if (matches.length > 0) { targetedWord = matches.sort((a,b) => b.y - a.y)[0]; inputStr = c; hit = true; }
            } else if (c === targetedWord.text[inputStr.length]) { 
                inputStr += c; hit = true; 
            }
            
            if (hit) { 
                sounds.correct(); 
                const lbl = document.getElementById('label-' + keyMap[c]);
                if (lbl) { lbl.classList.add('spark'); setTimeout(() => lbl.classList.remove('spark'), 250); }
            } else { sounds.wrong(); }

            if (targetedWord && inputStr === targetedWord.text) {
                score += inputStr.length * 10; typed++; activeWords = activeWords.filter(w => w !== targetedWord); targetedWord = null; inputStr = "";
                if (typed >= 20) showReport();
            }
            document.getElementById('input-display').innerText = inputStr || "READY"; updateUI();
        }

        function showReport() {
            reporting = true; sounds.levelUp();
            document.getElementById(`frag-${level}`).classList.add('collected');
            document.getElementById('artifact-reward-box').style.display = 'block';
            
            const isNewHigh = saveHighscore(score);
            document.getElementById('highscore-msg').style.display = isNewHigh ? 'block' : 'none';

            if (level === 6) {
                sounds.complete();
                document.getElementById('artifact-container').classList.add('complete');
                document.getElementById('rep-title').innerText = "üèÜ MASTER WIZARD!";
                document.getElementById('rep-stats').innerHTML = `<span style="font-size:1.1rem; color:var(--wizard-red); font-weight:bold;">Well done my dear Scarlett for completing this wizard challenge! I'm so proud of you!</span><br><br>Final Score: ${score}<br>Best Academy Score: ${getHighscore()}`;
                document.getElementById('advance-btn').innerText = "PLAY AGAIN (Enter)";
            } else {
                document.getElementById('rep-title').innerText = `üìú Year ${level} Complete!`;
                document.getElementById('rep-stats').innerText = `You found a fragment of the Medallion! Total Score: ${score} (Best: ${getHighscore()})`;
            }
            document.getElementById('report-card').style.display = 'flex';
        }

        function nextYear() { 
            if (document.getElementById('rep-title').innerText === "üßô Magic Exhausted!") { startGame(); return; } 
            if (level >= 6) { location.reload(); return; } 
            level++; 
            document.getElementById('report-card').style.display = 'none'; 
            document.getElementById('artifact-reward-box').style.display = 'none';
            resetGameSession(); lastS = performance.now(); requestAnimationFrame(loop); 
        }

        function endGame() { 
            reporting = true; sounds.wrong(); saveHighscore(score);
            document.getElementById('rep-title').innerText = "üßô Magic Exhausted!"; 
            document.getElementById('rep-stats').innerText = `Final Score: ${score}. Best Score: ${getHighscore()}`; 
            document.getElementById('report-card').style.display = 'flex'; 
        }

        window.addEventListener('keydown', (e) => {
            if (e.key === "Escape") { togglePause(); return; }
            if (e.key === "Enter") { if (!active) startGame(); else if (reporting) nextYear(); return; }
            
            // NATURAL BACKSPACE: One letter at a time
            if (e.key === "Backspace") { 
                if (inputStr.length > 0) {
                    inputStr = inputStr.slice(0, -1);
                    if (inputStr.length === 0) targetedWord = null; // Free up targeting if empty
                }
                document.getElementById('input-display').innerText = inputStr || "READY";
                updateUI(); 
                return; 
            }
            if (e.key.length === 1 && /[a-zA-Z]/.test(e.key)) { handleKey(e.key); }
        });

        /* --- iPad & External Keyboard Compatibility Bridge --- */
        window.addEventListener('input', (e) => {
            // This captures input from virtual keyboards and third-party iPad keyboards
            // that might bypass the standard 'keydown' listener.
            if (active && !reporting && !paused) {
                if (e.inputType === 'insertText' && e.data) {
                    const char = e.data.slice(-1); // Get the last typed character
                    if (/[a-zA-Z]/.test(char)) {
                        handleKey(char);
                    }
                } else if (e.inputType === 'deleteContentBackward') {
                    // Mimic the backspace logic
                    if (inputStr.length > 0) {
                        inputStr = inputStr.slice(0, -1);
                        if (inputStr.length === 0) targetedWord = null;
                    }
                    document.getElementById('input-display').innerText = inputStr || "READY";
                    updateUI();
                }
            }
        }, true);
        
        // Ensure the name input doesn't trigger game keys while typing
        document.getElementById('name-input').addEventListener('keydown', (e) => {
            // If Enter is pressed while the cursor is in the name box, start the game!
            if (e.key === "Enter") startGame(); 
            e.stopPropagation();
        });


        /* --- Global Controller for Enter, Escape, and Backspace --- */
        window.addEventListener('keydown', (e) => {
            // 1. Handle Pause/Resume
            if (e.key === "Escape") { 
                togglePause(); 
                return; 
            }
        
            // 2. Handle Game Entry and Level Advancement
            if (e.key === "Enter") {
                if (!active && !reporting) {
                    // We are at the Lobby/Start Screen
                    startGame();
                } else if (reporting) {
                    // We are at the Report Card screen
                    nextYear();
                }
                return;
            }
        
            // 3. Handle Natural Backspace (One letter at a time)
            if (e.key === "Backspace") { 
                if (inputStr.length > 0) {
                    inputStr = inputStr.slice(0, -1);
                    // If the word is now empty, un-target it so she can pick a different one
                    if (inputStr.length === 0) targetedWord = null; 
                }
                document.getElementById('input-display').innerText = inputStr || "READY";
                updateUI(); 
                return; 
            }
        
            // 4. Handle Standard Letter Typing
            if (e.key.length === 1 && /[a-zA-Z]/.test(e.key)) { 
                handleKey(e.key); 
            }
        });
    </script>
</body>
</html>
