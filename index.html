<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wizard Typing: Scarlett's Academy</title>
    <style>
        :root { --wizard-gold: #f1d38e; --wizard-red: #741b1b; --wizard-blue: #4facfe; --bg-dark: #0d0d1a; }
        body { margin: 0; overflow: hidden; background: var(--bg-dark); font-family: 'Georgia', serif; color: var(--wizard-gold); display: flex; flex-direction: column; height: 100vh; }
        
        #game-container { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        
        #ui-layer { width: 100%; padding: 15px; display: flex; justify-content: space-between; box-sizing: border-box; z-index: 20; background: var(--bg-dark); border-bottom: 3px solid var(--wizard-red); }
        canvas { flex: 1; display: block; width: 100%; background: #0d0d1a; }

        #snitch-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px; margin-top: 5px; }
        .snitch { width: 18px; height: 18px; fill: rgba(255,255,255,0.1); transition: all 0.4s ease; filter: grayscale(1); }
        .snitch.active { fill: #ffd700; filter: drop-shadow(0 0 5px #ffd700) grayscale(0); transform: scale(1.2); }
        #lives-display { color: #ff4d4d; font-size: 20px; letter-spacing: 2px; margin-top: 5px; }

        /* High Score Snitch Animation */
        #special-snitch {
            position: absolute; display: none; z-index: 50; pointer-events: none;
            flex-direction: column; align-items: center; text-align: center;
            animation: flyAround 6s infinite ease-in-out;
        }
        @keyframes flyAround {
            0% { transform: translate(10vw, 10vh); }
            25% { transform: translate(70vw, 30vh); }
            50% { transform: translate(20vw, 60vh); }
            75% { transform: translate(60vw, 10vh); }
            100% { transform: translate(10vw, 10vh); }
        }
        .congrats-bubble {
            background: var(--wizard-gold); color: var(--wizard-red);
            padding: 10px; border-radius: 15px; font-weight: bold;
            border: 2px solid var(--wizard-red); box-shadow: 0 0 15px var(--wizard-gold);
            margin-bottom: 5px; font-size: 14px;
        }

        #keyboard-section { height: 200px; background: #1a1a2e; border-top: 4px solid var(--wizard-red); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5px; position: relative; }
        .key-row { display: flex; }
        .key { width: 7vw; max-width: 42px; height: 42px; border: 1px solid #3d3d5c; border-radius: 6px; margin: 2px; display: flex; align-items: center; justify-content: center; font-size: 16px; font-family: 'Courier New', monospace; color: #5c5c8a; background: #121225; transition: 0.1s; }
        .key.active { background: var(--wizard-gold); color: #2a0a0a; box-shadow: 0 0 15px var(--wizard-gold); transform: scale(0.9); }
        .key.guide { border-color: var(--wizard-blue); box-shadow: 0 0 15px var(--wizard-blue); color: #fff; background: #1e3a5f; }

        #watermark { position: absolute; bottom: 8px; width: 100%; text-align: center; font-size: 14px; color: var(--wizard-gold); font-weight: bold; text-shadow: 0 0 8px rgba(241, 211, 142, 0.6); opacity: 0.9; pointer-events: none;}
        #input-display { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); font-size: 30px; color: #2a0a0a; background: var(--wizard-gold); padding: 5px 35px; border-radius: 10px; border: 3px solid var(--wizard-red); font-weight: bold; letter-spacing: 3px; z-index: 5; height: 40px; min-width: 120px; text-align: center; line-height: 40px;}

        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 100; background: rgba(13, 13, 26, 0.98); }
        .scroll { background: #f4e4bc; color: #2a0a0a; padding: 25px; border-radius: 8px; text-align: center; width: 85%; max-width: 400px; border: 3px solid #d4c49c; box-shadow: 0 0 30px #000; overflow-y: auto; max-height: 90vh; }
        
        #name-input { width: 80%; padding: 10px; font-size: 1.2rem; border: 2px solid var(--wizard-red); border-radius: 5px; text-align: center; margin: 10px 0; }
        .mode-selector { margin: 15px 0; background: rgba(0,0,0,0.1); padding: 10px; border-radius: 8px; }

        button { padding: 12px; font-size: 1.1rem; background: var(--wizard-red); color: var(--wizard-gold); border: 2px solid var(--wizard-gold); cursor: pointer; border-radius: 8px; font-weight: bold; margin-top: 10px; width: 100%; }
        button.load-btn { background: #3d3d5c; margin-top: 5px; font-size: 0.9rem; }
        button.save-btn { background: #2e4a3e; border-color: #4facfe; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="speed-controls" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 10px; z-index: 100;">
        <button onclick="changeSpeed(-0.2)" style="font-size: 24px; cursor: pointer; background: rgba(241, 211, 142, 0.2); color: #f1d38e; border: 2px solid #f1d38e; border-radius: 10px; padding: 10px;">‚ñ≤ Faster</button>
        <div style="text-align: center; font-family: Garamond, serif; font-weight: bold;">SPEED</div>
        <button onclick="changeSpeed(0.2)" style="font-size: 24px; cursor: pointer; background: rgba(241, 211, 142, 0.2); color: #f1d38e; border: 2px solid #f1d38e; border-radius: 10px; padding: 10px;">‚ñº Slower</button>
    </div>
    
    <div id="special-snitch">
        <div class="congrats-bubble">NEW HIGH SCORE!<br>Amazing job, Scarlett! ‚ú®</div>
        <svg width="60" height="60" viewBox="0 0 24 24" fill="#ffd700"><path d="M12,2L10,5L12,8L14,5L12,2M12,10C8.69,10 6,12.69 6,16C6,19.31 8.69,22 12,22C15.31,22 18,19.31 18,16C18,12.69 15.31,10 12,10M12,20C9.79,20 8,18.21 8,16C8,13.79 9.79,12 12,12C14.21,12 16,13.79 16,16C16,18.21 14.21,20 12,20M2,16C2,14 4,12 4,12C4,12 4,16 2,16M22,16C22,14 20,12 20,12C20,12 20,16 22,16Z"/></svg>
    </div>

    <div id="start-screen" class="overlay">
        <div class="scroll" style="background: #1a1a2e; color: var(--wizard-gold); border-color: var(--wizard-gold);">
            <h1>Wizard Academy</h1>
            <input type="text" id="name-input" placeholder="Scarlett" maxlength="12">
            <div class="mode-selector">
                <label><input type="radio" name="lives-mode" value="999" checked> ‚ôæÔ∏è Unlimited</label>
                <label><input type="radio" name="lives-mode" value="5"> ‚ù§Ô∏è 5 Lives</label>
            </div>
            <button onclick="startGame()">NEW LESSON</button>
            <button id="load-btn-ui" class="load-btn" onclick="loadGame()" style="display:none;">CONTINUE PREVIOUS GAME</button>
            <h3 style="margin: 15px 0 5px 0;">üèÜ Hall of Fame</h3>
            <table id="score-list-start" style="width:100%; font-size:0.8rem;"></table>
        </div>
    </div>

    <div id="pause-screen" class="overlay" style="display: none;">
        <div class="scroll" style="background: #1a1a2e; border: 3px solid var(--wizard-blue);">
            <h1 style="color: var(--wizard-blue);">Magic Suspended</h1>
            <p style="color: white;">The Time-Turner has paused the lesson.</p>
            <button onclick="togglePause()" style="background: var(--wizard-blue);">RESUME MAGIC (Esc)</button>
        </div>
    </div>

    <div id="report-card" class="overlay" style="display: none;">
        <div class="scroll">
            <h1 id="rep-title">üìú Year Passed!</h1>
            <p id="rep-stats"></p>
            <div id="final-stats" style="display:none;"><table id="score-list-report" style="width:100%;"></table></div>
            <button onclick="nextYear()">NEXT YEAR (Enter)</button>
            <button class="save-btn" onclick="saveCurrentGame()">üíæ SAVE & QUIT</button>
        </div>
    </div>

    <div id="game-container">
        <div id="ui-layer">
            <div>YEAR: <span id="lvl-val">1</span><div id="lives-display"></div></div>
            <div id="progress-center">
                <div style="font-size: 10px;">GOLDEN SNITCHES</div>
                <div id="snitch-grid"></div>
            </div>
            <div>POINTS: <span id="score-val">0</span></div>
        </div>
        <canvas id="gameCanvas"></canvas>
        <div id="input-display">READY</div>
    </div>

    <div id="keyboard-section">
        <div class="key-row" id="r1"></div>
        <div class="key-row" id="r2"></div>
        <div class="key-row" id="r3"></div>
        <div id="watermark">Made for Scarlett, by Daddy ‚ú®</div>
    </div>

    <template id="snitch-svg">
        <svg class="snitch" viewBox="0 0 24 24"><path d="M12,2L10,5L12,8L14,5L12,2M12,10C8.69,10 6,12.69 6,16C6,19.31 8.69,22 12,22C15.31,22 18,19.31 18,16C18,12.69 15.31,10 12,10M12,20C9.79,20 8,18.21 8,16C8,13.79 9.79,12 12,12C14.21,12 16,13.79 16,16C16,18.21 14.21,20 12,20M2,16C2,14 4,12 4,12C4,12 4,16 2,16M22,16C22,14 20,12 20,12C20,12 20,16 22,16Z"/></svg>
    </template>

    <script>
        // --- IPAD KEYBOARD FIX START ---
        document.addEventListener('touchstart', function() {
            window.focus();
            let hiddenInput = document.getElementById('kb-fix');
            if (!hiddenInput) {
                hiddenInput = document.createElement('input');
                hiddenInput.id = 'kb-fix';
                hiddenInput.type = 'text';
                hiddenInput.style.position = 'fixed';
                hiddenInput.style.opacity = '0';
                document.body.appendChild(hiddenInput);
            }
        hiddenInput.focus();
        });
        // --- IPAD KEYBOARD FIX END ---
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const seeds = ["WAND", "ROBE", "OWL", "HAT", "INK", "FLY", "CAT", "RAT", "CUP", "BOY", "MAP", "KEY", "BED", "TEA", "SUN", "BAG", "BOOK", "TOAD", "GOLD", "GATE", "FIRE", "WALL", "CAKE", "WIND", "BIRD", "SNOW", "SHIP", "MILK", "JUMP", "DARK", "FAST", "LOCK", "DOOR", "WOOD", "TREE", "SOUP", "COIN", "DUST", "DESK", "FROG", "MAGIC", "CLOAK", "TRAIN", "GHOST", "SPELL", "BRICK", "STONE", "BROOM", "STAIR", "PIZZA", "STARS", "NIGHT", "LIGHT", "GLOVE", "SNAKE", "MOUSE", "VAULT", "SCARF", "POTION", "WIZARD", "CASTLE", "DRAGON", "GOBLIN", "MIRROR", "SCHOOL", "FLOWER", "GIANTS", "DIARY", "SPIDER", "FOREST", "KNIGHT", "SILVER", "PURPLE", "SHIELD", "SPIRIT", "ARMOR", "GARDEN", "KITCHEN", "PUMPKIN", "BROOMS", "CAULDRON", "FEATHER", "LIBRARY", "WHISPER", "PHANTOM", "ALCHEMY", "CRYSTAL", "LANTERN", "SHADOW", "TOWER", "BRIDGE", "SCROLL", "BEAST", "TICKET", "CANDLE", "REMEDY", "BREW", "ELIXIR", "TALENT", "QUEST", "AMULET", "CHARM", "JINX", "HEX", "RUNE", "SIGHT", "DREAM", "FLAME", "FROST", "STORM", "CLOUD", "POWER", "CROWN", "SCEPTRE", "VALLEY", "MOUNTAIN", "ISLAND", "OCEAN", "DESERT", "JUNGLE", "CAVERN", "TUNNEL", "TEMPLE", "STATUE", "PILLAR", "THRONE", "CHAMBER", "PASSAGE", "SECRET", "RIDDLE", "PUZZLE", "SYMBOL", "LEGEND", "FABLE", "STORY", "MYTH", "REWARD", "TROPHY", "MEDAL", "BADGE", "TOKEN", "JEWEL", "DIAMOND", "RUBY", "PEARL", "EMERALD", "SAPPHIRE", "BOTTLE", "CHEST", "BASKET", "HAMMER", "CHISEL", "NEEDLE", "THREAD", "FABRIC", "LEATHER", "CANVAS", "GRIFFIN", "PHOENIX", "UNICORN", "DRAGON", "CENTAUR", "MERMAID", "PIXIE", "FAIRY", "GNOME", "TROLL", "GIANT", "GOLEM", "SPIRIT", "WRAITH", "BANSHEE", "SPECTRE", "KEEPER", "MASTER", "ELDER", "LEADER", "FRIEND", "COUSIN", "FAMILY", "SISTER", "BROTHER", "FATHER", "MOTHER"].map(w => w.toUpperCase());

        const layout = ["QWERTYUIOP", "ASDFGHJKL", "ZXCVBNM"];
        layout.forEach((row, i) => {
            const container = document.getElementById(`r${i+1}`);
            row.split("").forEach(char => {
                const k = document.createElement('div');
                k.className = 'key'; k.id = 'k-' + char; k.innerText = char;
                container.appendChild(k);
            });
        });

        const snitchGrid = document.getElementById('snitch-grid');
        const snitchTemplate = document.getElementById('snitch-svg');
        for(let i=0; i<20; i++) snitchGrid.appendChild(snitchTemplate.content.cloneNode(true));

        let activeWords = [], score = 0, level = 1, typed = 0, lives = 5, active = false, reporting = false, paused = false, playerName = "Scarlett", inputStr = "", lastS = 0, targetedWord = null;

        function saveCurrentGame() {
            const gameState = { score, level, lives, playerName, mode: document.querySelector('input[name="lives-mode"]:checked').value };
            localStorage.setItem('wizard_save', JSON.stringify(gameState));
            location.reload(); 
        }

        function loadGame() {
            const saved = localStorage.getItem('wizard_save');
            if(!saved) return;
            const data = JSON.parse(saved);
            score = data.score; level = data.level; lives = data.lives; playerName = data.playerName;
            document.getElementById('name-input').value = playerName;
            startGame(true);
        }

        function changeSpeed(delta) {
            fallSpeed -= delta; 
            if (fallSpeed < 0.5) fallSpeed = 0.5;
            if (fallSpeed > 10) fallSpeed = 10;
        
            // ADD THIS LINE: It puts the "focus" back on the game so she can keep typing immediately
            window.focus(); 
        }
        
        function togglePause() {
            if (!active || reporting) return;
            paused = !paused;
            document.getElementById('pause-screen').style.display = paused ? 'flex' : 'none';
            if (!paused) { lastS = performance.now(); requestAnimationFrame(loop); }
            document.getElementById('special-snitch').style.animationPlayState = paused ? 'paused' : 'running';
        }

        function checkLoadButton() {
            if(localStorage.getItem('wizard_save')) document.getElementById('load-btn-ui').style.display = 'block';
        }

        function getHighScores() {
            const saved = localStorage.getItem('wizardScores');
            return saved ? JSON.parse(saved) : [{name: "Scarlett", score: 100, year: 1}];
        }

        function saveScore() {
            let scores = getHighScores();
            const topScore = scores.length > 0 ? scores[0].score : 0;
            if(score > topScore) {
                document.getElementById('special-snitch').style.display = 'flex';
                setTimeout(() => document.getElementById('special-snitch').style.display = 'none', 6000);
            }
            scores.push({name: playerName, score: score, year: level});
            scores.sort((a, b) => b.score - a.score);
            localStorage.setItem('wizardScores', JSON.stringify(scores.slice(0, 5)));
            displayScores();
        }

        function displayScores() {
            const scores = getHighScores();
            const content = `<tr><th>Rank</th><th>Name</th><th>Yr</th><th>Score</th></tr>` + 
                scores.map((s, i) => `<tr><td>${i+1}</td><td>${s.name}</td><td>${s.year}</td><td>${s.score}</td></tr>`).join('');
            document.getElementById('score-list-start').innerHTML = content;
            document.getElementById('score-list-report').innerHTML = content;
        }

        function startGame(isLoad = false) {
            if(!isLoad) {
                playerName = document.getElementById('name-input').value || "Scarlett";
                lives = parseInt(document.querySelector('input[name="lives-mode"]:checked').value);
                score = 0; level = 1;
            }
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('report-card').style.display = 'none';
            typed = 0; activeWords = []; inputStr = ""; active = true; reporting = false; paused = false; targetedWord = null;
            resetSnitches(); resize(); updateUI(); requestAnimationFrame(loop);
        }

        function resetSnitches() { document.querySelectorAll('.snitch').forEach(s => s.classList.remove('active')); }
        function resize() { canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight; }
        window.onresize = resize;

        function updateUI() {
            document.getElementById('score-val').innerText = score;
            document.getElementById('lvl-val').innerText = level;
            document.getElementById('lives-display').innerText = lives > 10 ? "‚ôæÔ∏è" : "‚ù§Ô∏è".repeat(lives);
            const snitches = document.querySelectorAll('.snitch');
            snitches.forEach((s, i) => i < typed ? s.classList.add('active') : s.classList.remove('active'));
            
            document.querySelectorAll('.key').forEach(k => k.classList.remove('guide'));
            if (targetedWord) {
                let char = targetedWord.text[inputStr.length];
                if (char) document.getElementById('k-' + char)?.classList.add('guide');
            } else if (activeWords.length > 0) {
                // Show guides for all possible starting letters
                activeWords.forEach(w => {
                    document.getElementById('k-' + w.text[0])?.classList.add('guide');
                });
            }
        }

        class Word {
            constructor() {
                const lengthGoal = level + 2;
                const filtered = seeds.filter(w => level === 1 ? w.length === 3 : (level === 2 ? w.length === 4 : w.length >= lengthGoal));
                this.text = filtered[Math.floor(Math.random() * filtered.length)] || seeds[0];
                this.x = Math.random() * (canvas.width - 180) + 90;
                this.y = -20;
                this.speed = 0.2 + (level * 0.15);
            }
            draw() {
                ctx.textAlign = "center";
                if (targetedWord === this) {
                    ctx.font = "bold 32px 'Courier New'";
                    const typedWidth = ctx.measureText(this.text.substring(0, inputStr.length)).width;
                    const fullWidth = ctx.measureText(this.text).width;
                    const startX = this.x - (fullWidth/2);
                    
                    ctx.fillStyle = "#ffffff";
                    ctx.fillText(this.text.substring(0, inputStr.length), startX + (typedWidth/2), this.y);
                    ctx.fillStyle = "#ffd700";
                    ctx.fillText(this.text.substring(inputStr.length), startX + typedWidth + (ctx.measureText(this.text.substring(inputStr.length)).width/2), this.y);
                } else {
                    ctx.fillStyle = "#f1d38e";
                    ctx.font = "bold 26px 'Courier New'";
                    ctx.fillText(this.text, this.x, this.y);
                }
            }
        }

        function loop(t) {
            if (!active || reporting || paused) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (t - lastS > (6000 - (level * 500))) {
                activeWords.push(new Word());
                lastS = t;
            }
            activeWords.forEach((w, i) => {
                w.y += w.speed;
                w.draw();
                if (w.y > canvas.height) {
                    if (targetedWord === w) { targetedWord = null; inputStr = ""; }
                    activeWords.splice(i, 1);
                    if (lives <= 5) { lives--; if (lives <= 0) endGame(); }
                    updateUI();
                }
            });
            requestAnimationFrame(loop);
        }

        function endGame() {
            reporting = true; saveScore();
            document.getElementById('rep-title').innerText = "üßô Magic Exhausted!";
            document.getElementById('rep-stats').innerText = `${playerName}: ${score} Points`;
            document.getElementById('final-stats').style.display = 'block';
            document.getElementById('report-card').style.display = 'flex';
        }

        function handleKey(char) {
            if (!active || reporting || paused) return;
            const c = char.toUpperCase();
            const kEl = document.getElementById('k-' + c);
            if (kEl) { kEl.classList.add('active'); setTimeout(() => kEl.classList.remove('active'), 120); }

            if (!targetedWord) {
                // Find lowest word starting with this letter
                const matches = activeWords.filter(w => w.text.startsWith(c));
                if (matches.length > 0) {
                    targetedWord = matches.sort((a,b) => b.y - a.y)[0];
                    inputStr = c;
                }
            } else if (c === targetedWord.text[inputStr.length]) {
                inputStr += c;
            }

            if (targetedWord && inputStr === targetedWord.text) {
                score += inputStr.length * 10;
                typed++;
                activeWords = activeWords.filter(w => w !== targetedWord);
                targetedWord = null;
                inputStr = "";
                if (typed >= 20) {
                    reporting = true;
                    document.getElementById('rep-title').innerText = `üìú Year ${level} Complete!`;
                    document.getElementById('rep-stats').innerText = `Accuracy Bonus!`;
                    document.getElementById('final-stats').style.display = 'none';
                    document.getElementById('report-card').style.display = 'flex';
                }
            }
            document.getElementById('input-display').innerText = inputStr || "READY";
            updateUI();
        }

        function nextYear() {
            if (document.getElementById('rep-title').innerText === "üßô Magic Exhausted!") { startGame(); return; }
            level++; typed = 0; activeWords = []; inputStr = ""; targetedWord = null;
            document.getElementById('report-card').style.display = 'none';
            reporting = false; lastS = performance.now();
            resetSnitches(); updateUI(); requestAnimationFrame(loop);
        }

        window.addEventListener('keydown', (e) => {
            if (e.key === "Escape") { togglePause(); return; }
            if (e.key === "Enter") { if (!active) startGame(); else if (reporting) nextYear(); return; }
            if (e.key === "Backspace") { inputStr = ""; targetedWord = null; document.getElementById('input-display').innerText = "READY"; updateUI(); } 
            else if (e.key.length === 1 && /[a-zA-Z]/.test(e.key)) { handleKey(e.key); }
        });

        displayScores();
        checkLoadButton();
    </script>
</body>
</html>
